name: CI/CD - Estacione F√°cil

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  frontend-build:
    name: Build e Test Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Instalar depend√™ncias do frontend
      run: npm ci
      
    - name: Verificar erros de TypeScript
      run: npx tsc --noEmit
      continue-on-error: false
      
    - name: Build do frontend
      run: npm run build
      
    - name: Upload artefatos do build
      uses: actions/upload-artifact@v3
      with:
        name: frontend-dist
        path: dist/
        retention-days: 7

  api-test:
    name: Test API Backend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: api/package-lock.json
        
    - name: Instalar depend√™ncias da API
      run: |
        cd api
        npm ci
        
    - name: Executar testes da API
      run: |
        cd api
        npm test
        
    - name: Verificar se a API inicia corretamente
      run: |
        cd api
        timeout 10s npm start || code=$?
        if [ $code -eq 124 ]; then
          echo "API iniciou com sucesso"
          exit 0
        else
          echo "Erro ao iniciar API"
          exit 1
        fi

  quality-check:
    name: Verifica√ß√£o de Qualidade
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3
      
    - name: Verificar arquivos obrigat√≥rios
      run: |
        echo "Verificando estrutura do projeto..."
        [ -f "README.md" ] && echo "‚úì README.md encontrado" || (echo "‚úó README.md n√£o encontrado" && exit 1)
        [ -d "api" ] && echo "‚úì Pasta api/ encontrada" || (echo "‚úó Pasta api/ n√£o encontrada" && exit 1)
        [ -f "api/server.js" ] && echo "‚úì API server.js encontrado" || (echo "‚úó API server.js n√£o encontrado" && exit 1)
        [ -d ".github/workflows" ] && echo "‚úì GitHub Actions configurado" || (echo "‚úó GitHub Actions n√£o configurado" && exit 1)
        echo "‚úì Todos os arquivos obrigat√≥rios presentes"
        
    - name: Verificar conven√ß√£o de commits (√∫ltima mensagem)
      run: |
        LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
        echo "√öltima mensagem de commit: $LAST_COMMIT_MSG"
        if echo "$LAST_COMMIT_MSG" | grep -qE "^(feat|fix|docs|style|refactor|test|chore):"; then
          echo "‚úì Commit segue conven√ß√£o sem√¢ntica"
        else
          echo "‚ö† Commit n√£o segue conven√ß√£o sem√¢ntica (feat:|fix:|docs:|etc)"
          echo "Isso n√£o impedir√° o build, mas √© recomendado seguir a conven√ß√£o"
        fi

  deployment-ready:
    name: Pronto para Deploy
    runs-on: ubuntu-latest
    needs: [frontend-build, api-test, quality-check]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3
      
    - name: Notificar sucesso
      run: |
        echo "=========================================="
        echo "‚úì Todos os testes passaram!"
        echo "‚úì Build do frontend conclu√≠do"
        echo "‚úì API testada com sucesso"
        echo "‚úì Verifica√ß√µes de qualidade OK"
        echo "=========================================="
        echo "Projeto pronto para deploy! üöÄ"
